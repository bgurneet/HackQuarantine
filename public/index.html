<!DOCTYPE html>
<html>
<head>
	<title>Title</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href='https://fonts.googleapis.com/css?family=Darker Grotesque' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Archivo Black' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Chau Philomene One' rel='stylesheet'>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script src="/__/firebase/7.12.0/firebase-app.js"></script>
	<!-- TODO: Add SDKs for Firebase products that you want to use
	     https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="/__/firebase/7.12.0/firebase-analytics.js"></script>
	<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

	<!-- Initialize Firebase -->
	<script src="/__/firebase/init.js"></script>
	<script src="/__/firebase/7.12.0/firebase-auth.js"></script>
	<script src="/__/firebase/7.12.0/firebase-database.js"></script>
	<script src="/__/firebase/7.12.0/firebase-functions.js"></script>
	<script type="text/javascript">
		var functions = firebase.functions();
		var auth = firebase.auth();
		// firebase.auth().onAuthStateChanged(function(user) {
		//   if (user) {
		//   	// there is a user signed in on the current session
		//     window.location.href = "accountsetup.html";
		//   }
		// });
	</script>
	<!--<script src="./app.js"></script>-->
	<style>
	h1 {
		font-family: 'Chau Philomene One';
		letter-spacing: 2px;
		font-size: calc(30px + (45 - 30) * ((100vw - 1000px) / (2600 - 1000)));
	}

	html {
		display: unset;
    color: unset;
	}

	body {
		margin: 0px;
		margin-top: 0px;
		border: 1px solid transparent;
		overflow: hidden;
		min-width: 1000px;
		min-height: 300px;

	}

	button {
		cursor: pointer;
	}
	a {
		cursor: pointer;
	}


	.header {
		padding: 1px;
		background:#1a7c72;
		color: white;
		z-index: 2;
		position:relative;
		border-top-left-radius: 28px;
		border-top-right-radius: 28px;
	}
	.fullBackgroundContainer {
		height: 100%;
		width: 100%;
		position: absolute;
		border: 0px;
		background-image: url("online-3217733_1920.jpg");
		background-position: center;
		background-repeat: no-repeat;
		background-size: cover;
		min-width: 1000px;
		min-height: 600px;
	}

	.smallerBackgroundContainer {
		height: 80%;
		width: 60%;
		margin-left: 20%;
		margin-top: 5%;
		background-color: rgba(255,255,255,0.9);;
		position: absolute;
		border-radius: 30px;
		box-shadow: 0px 0px 10px 0px #165054;
	}

	.split {
	  height: 100%;
	  width: 50%;
	  position: absolute;
	  z-index: 1;
	  top: 0;
	  overflow-x: hidden;
	}

	.left {
  	left: 0;
		border-right: 1px solid #E0E0E0;
	}

	.right {
  	right: 0;
		border-left: 1px solid #E0E0E0;
	}

	.fa {
  	padding: 15px;
  	font-size: 30px;
  	width: 30px;
  	text-align: center;
  	text-decoration: none;
  	margin: 5px 2px;
  	border-radius: 50%;
	}
	.fa:hover {
    opacity: 0.7;
	}

	.fa-facebook {
  	background: #3B5998;
  	color: white;
	}

	.fa-google {
  	background: #dd4b39;
  	color: white;
	}

	.fa-twitter {
  	background: #55ACEE;
  	color: white;
	}

	.entryBox {
    border-radius: 25px;
    border: 2px solid	#e3e1df;
		margin: 5px;
    padding: 3.5%;
		padding-top: 3%;
    width: 35%;
		padding-top: 3%;
    height: 1vh;
		background-color:	#e3e1df;
		font-size: calc(2px + 2vh);
		letter-spacing: 1px;
		font-family: 'Darker Grotesque';
		font-weight: bold;
		line-height: 0px;
	}

	.socials {
		clear: both;
		display:block;
		margin-left: auto;
		margin-right: auto;
		width: 230px
	}

	.adjacentEntryBox {
		clear: both;
		display: block;
	}

	.subButton {
		border-radius: 25px;
    border: 1px solid	#26b3a3;
    padding: 3.5%;
		padding-top: 2.5%;
    width: 35%;
    height: 10%;
		padding-top: 2.5%;
		background-color:	#26b3a3;
		color: white;
		font-size: calc(2px + 2vh);
		margin: 0 auto;
		margin-top:2%;
    display: block;
		line-height: 0px;
		font-family: 'Darker Grotesque';
		font-weight: bold;
	}

	.buttonContainer {
		vertical-align: middle;
		width: 100%;
		height: 50%;
		margin-top:50%;
		margin: auto;
		position: absolute;
		top: 0; right: 0;
		bottom: 0; left: 0;
	}
	input:focus {
		outline: none;
		background-color:	white;
	}


	select:focus,
	textarea:focus,
	button:focus {
    outline: none
	}

	svg{
		width: 100px;
		height: 100px;
		left: 50%;
		display:inline-block;
	}
	svg circle {
		stroke: #419385;
	}
	svg rect {
		fill: #89CAD4;
	}
	#loadingAnimation {
		position: fixed;
		left: 50%;
		top: 50%;
		transform: translate(-50%, -50%);
		z-index: 3;
	}


	</style>
</head>
<body>

	<!-- Assuming that Haikal + Finn will be putting their code in this file. I am serving this file as the first instance from the node server -->
	<div class = "fullBackgroundContainer" id="fullBackgroundContainer" >
		<div id="loadingAnimation" class="center" hidden=true>
		<svg version="1.1" id="L1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
    <circle fill="none" stroke-width="6" stroke-miterlimit="15" stroke-dasharray="14.2472,14.2472" cx="50" cy="50" r="47" >
      <animateTransform
         attributeName="transform"
         attributeType="XML"
         type="rotate"
         dur="5s"
         from="0 50 50"
         to="360 50 50"
         repeatCount="indefinite" />
  </circle>
  <circle fill="none" stroke="#fff" stroke-width="1" stroke-miterlimit="10" stroke-dasharray="10,10" cx="50" cy="50" r="39">
      <animateTransform
         attributeName="transform"
         attributeType="XML"
         type="rotate"
         dur="5s"
         from="0 50 50"
         to="-360 50 50"
         repeatCount="indefinite" />
  </circle>
  <g fill="#fff">
  <rect x="30" y="35" width="5" height="30">
    <animateTransform
       attributeName="transform"
       dur="1s"
       type="translate"
       values="0 5 ; 0 -5; 0 5"
       repeatCount="indefinite"
       begin="0.1"/>
  </rect>
  <rect x="40" y="35" width="5" height="30" >
    <animateTransform
       attributeName="transform"
       dur="1s"
       type="translate"
       values="0 5 ; 0 -5; 0 5"
       repeatCount="indefinite"
       begin="0.2"/>
  </rect>
  <rect x="50" y="35" width="5" height="30" >
    <animateTransform
       attributeName="transform"
       dur="1s"
       type="translate"
       values="0 5 ; 0 -5; 0 5"
       repeatCount="indefinite"
       begin="0.3"/>
  </rect>
  <rect x="60" y="35" width="5" height="30" >
    <animateTransform
       attributeName="transform"
       dur="1s"
       type="translate"
       values="0 5 ; 0 -5; 0 5"
       repeatCount="indefinite"
       begin="0.4"/>
  </rect>
  <rect x="70" y="35" width="5" height="30" >
    <animateTransform
       attributeName="transform"
       dur="1s"
       type="translate"
       values="0 5 ; 0 -5; 0 5"
       repeatCount="indefinite"
       begin="0.5"/>
  </rect>
  </g>
</svg>
	</div>
	<div class = "smallerBackgroundContainer">
		<div id ="header" class = "header">
			<H1 style="text-align:center; z-index: 2; position:relative; background-color:#1a7c72; font-size: calc(20px + 5vh); letter-spacing: 5px;">TITLE</h1>
		</div>
	<div id = "right" class="split left">

	<div id = "1" class = "buttonContainer" style = "text-align:center;" >
		<h1 style = "color: #404040;">CREATE ACCOUNT</h1>
	<div class = "socials">
		<a id = "facebook" class="fa fa-facebook"></a>
		<a id = "google" class="fa fa-google"></a>
		<a class="fa fa-twitter"></a>
	</div>
		<hr>
	<form id="regform" onsubmit="regsubmit();">
		<div id = "2" class = "adjacentEntryBox">
			<input type="text" id="username" class = "entryBox" placeholder= "Username" required/>
			<input type="email" id="email" class = "entryBox" placeholder= "Email" required/>
		</div>
		<div class = "adjacentEntryBox">
			<input type="password" id="password" class = "entryBox" placeholder= "Password" required/>
			<input type="text" id="phone" class = "entryBox" placeholder= "Phone" required/>
		</div>
			<button id = "RegButton" type="submit" class = "subButton">Register</button>
		</div>
	</form>
</div>

<div id = "right" class="split right">
<div class = "buttonContainer" style = "text-align:center;">
	<h1 style = "color: #404040;">SIGN IN</h1>
<div class = "socials">
	<a id="facebook" class="fa fa-facebook"></a>
	<a id="google" class="fa fa-google"></a>
	<a href="#" class="fa fa-twitter"></a>
</div>
	<hr>
	<form id="logform" onsubmit="loginSubmit();">
		<div id = "2" class = "adjacentEntryBox">
			<input id = "loginUsername" type="text" class="entryBox" placeholder="Username/email" required/>
			<input id = "loginPassword" type="password" class="entryBox" placeholder="Password" required/>
		</div>
		<button id="logButton" type="submit" class="subButton">Login</button>
	</form>
</div>
</div>
</div>
</div>
<script>

	$(document).ready(function(){
		$(".subButton").on('mouseenter', function(){
			$(this).css({padding: '3.7%',
									'padding-top':'2.9%',
									width:'35.5%',
									'margin-top':'1.8%'
								});
			/*
			$(this).css('padding-top', '18px');
			$(this).css('font-size', '21px');
			$(this).css('width', '205px');
			$(this).css('margin-top', '9px');
			*/
		});
		$(".subButton").on('mouseleave', function(){
			$(this).css({padding: '3.5%',
									'padding-top':'2.5%',
									width:'35%',
									'margin-top':'2%'
								});

		});
		$(".smallerBackgroundContainer").css({
			left: $( window ).width()
							});
		$(".smallerBackgroundContainer").animate({
			left:0
		});
		$('form').submit(function(event){
			event.preventDefault();
		});
		// connecting the registration button here for access in Node JS
		/*$('#regform').submit(function (event) {
			$.post('https://us-central1-hq-app-8cc14.cloudfunctions.net/register', {username: $('#username').val(), email: $('#email').val(), password: $('password').val(), phone: $('phone').val()}, function(data) {
				console.log(data);
			}, 'json');
	});*/
	});
	</script>
	<!--<div id='firebaseui-auth-container'></div>-->
	<script type="text/javascript">
		function googleRegistration() {
			console.log("here");
			console.log("Clicked")
			$('#fullBackgroundContainer *').attr("disabled", "disabled").off('click');
			document.getElementById('loadingAnimation').hidden = false;
			var provider = new firebase.auth.GoogleAuthProvider();
			firebase.auth().signInWithPopup(provider).then(function(result) {
		  		// This gives you a Google Access Token. You can use it to access the Google API.
		  		if(result.additionalUserInfo.isNewUser) {
					// add the users details to the database and then move them to account setup
					var register = firebase.functions().httpsCallable('register');
					register({userid: auth.currentUser.uid, username: auth.currentUser.email, email: auth.currentUser.email, phone: null}).then(function(result) {
							console.log(result);
							window.location.href = "accountsetup.html";
					});

		  		} else {
		  			window.location.href = "dashboard.html";
		  		}

		  		var token = result.credential.accessToken;
		  		// The signed-in user info.
		  		var user = result.user;
				console.log(user);


			}).catch(function(error) {
		  		// Handle Errors here.
		  		var errorCode = error.code;
		  		var errorMessage = error.message;
		  		// The email of the user's account used.
		  		var email = error.email;
		  		// The firebase.auth.AuthCredential type that was used.
		  		var credential = error.credential;
				console.log(errorCode)
				console.log(errorMessage)
				$('#fullBackgroundContainer *').attr("disabled", false).on('click');
				document.getElementById('loadingAnimation').hidden = true;
	  			// ...
			})
		}
		function regsubmit() {
			$('#fullBackgroundContainer *').attr("disabled", "disabled").off('click');
			document.getElementById('loadingAnimation').hidden = false;
			var username = document.getElementById('username').value;
			var email = document.getElementById('email').value;
			var password = document.getElementById('password').value;
			var phone = document.getElementById('phone').value;
			var userUnique = firebase.functions().httpsCallable("checkIfUserUnique");
			userUnique({username: username.value}).then(function(result) {
				console.log(result);
				if(result.data) {
					const promise = auth.createUserWithEmailAndPassword(email, password);
					console.log(promise);
					promise.then(user => {
						console.log(user);
					  //user.sendEmailVerification();
					  auth.currentUser.sendEmailVerification();
					  var register = firebase.functions().httpsCallable('register');
						register({userid: auth.currentUser.uid, username: username, email: email, phone: phone, password: password}).then(function(result) {
								console.log(result);
								window.location.href = "accountsetup.html";
								// TODO: Do anything that needs to happen after the reg form is submitted over here (like changing pages etc.)
						});
					}).catch(error => {
						$('#fullBackgroundContainer *').attr("disabled", false).on('click');
						document.getElementById('loadingAnimation').hidden = true;
						alert(error);
					});
				} else {
					$('#fullBackgroundContainer *').attr("disabled", false).on('click');
					document.getElementById('loadingAnimation').hidden = true;
					alert("Username taken!");
				}
			}).catch(error => {
				$('#fullBackgroundContainer *').attr("disabled", false).on('click');
				document.getElementById('loadingAnimation').hidden = true;
				alert(error);
			});
		}

	function loginSubmit() {
		var email = document.getElementById('loginUsername').value;
		var password = document.getElementById('loginPassword').value;
		console.log(email);
		console.log(password)
		const promise = auth.signInWithEmailAndPassword(email, password);
		promise.then(user => {
			$('#fullBackgroundContainer *').attr("disabled", true).off('click');
			document.getElementById('loadingAnimation').hidden = false;
			window.location.href = "dashboard.html";
		}).catch(function(error) {
  		// Handle Errors here.
  		var errorCode = error.code;
  		var errorMessage = error.message;
			console.log(errorCode)
			console.log(errorMessage)
		});
	}
	</script>

	<script>
	$(".fa-google").click(function() {
		$('#fullBackgroundContainer *').attr("hidden", true).on('click');
		document.getElementById('loadingAnimation').hidden = false;
		// Provider is google
		var provider = new firebase.auth.GoogleAuthProvider();
		firebase.auth().signInWithPopup(provider).then(function(result) {
			if(result.additionalUserInfo.isNewUser) {
				// If they are a new user make their email valid (Already validated by facebook)
				// Add details to database and move to account setup
				var register = firebase.functions().httpsCallable('register');
				register({userid: auth.currentUser.uid, username: auth.currentUser.email, email: auth.currentUser.email, phone: null}).then(function(result) {
					window.location.href = "accountsetup.html";
				});
			} else {
				// If they are not a new user check if they have completed reg and move
				// to appropriate page.
				var checkRegistrationStatus = firebase.functions().httpsCallable('checkRegistrationStatus');
				checkRegistrationStatus({uid: auth.currentUser.uid}).then(function(result) {
					if(result.data) {
						// they have completed the registration process (account setup)
						window.location.href = "dashboard.html";
					} else {
						// they have not completed setup
						window.location.href = "accountsetup.html";
					}
				})
			}
		}).catch(function(error) {
  		// Handle Errors here.
  		var errorCode = error.code;
  		var errorMessage = error.message;
  		// The email of the user's account used.
  		var email = error.email;
  		// The firebase.auth.AuthCredential type that was used.
  		var credential = error.credential;
			console.log(errorCode)
			console.log(errorMessage)
			$('#fullBackgroundContainer *').attr("disabled", false).on('click');
			document.getElementById('loadingAnimation').hidden = true;
  		// ...
		})
	});


	$(".fa-facebook").click(function() {
		$('#fullBackgroundContainer *').attr("hidden", true).on('click');
		document.getElementById('loadingAnimation').hidden = false;
		// Provider is facebook
		var provider = new firebase.auth.FacebookAuthProvider();
		// Create popup
		auth.signInWithPopup(provider)
		.then(function(result) {
			// Check if they are a new user
			if(result.additionalUserInfo.isNewUser) {
				// If they are a new user make their email valid (Already validated by facebook)
				// Add details to database and move to account setup
				var register = firebase.functions().httpsCallable('register');
				register({userid: auth.currentUser.uid, username: auth.currentUser.email, email: auth.currentUser.email, phone: null}).then(function(result) {
					var makeValid = firebase.functions().httpsCallable('setEmailValid');
					makeValid({userid: auth.currentUser.uid}).then(() => {
					});
					window.location.href = "accountsetup.html";
				});
			} else {
				// If they are not a new user check if they have completed reg and move
				// to appropriate page.
				var checkRegistrationStatus = firebase.functions().httpsCallable('checkRegistrationStatus');
				checkRegistrationStatus({uid: auth.currentUser.uid}).then(function(result) {
					if(result.data) {
						// they have completed the registration process (account setup)
						window.location.href = "dashboard.html";
					} else {
						// they have not completed setup
						window.location.href = "accountsetup.html";
					}
				})
			}
		})
		.catch(function(error) {
			//If already signed in using a different method on same email
		  if (error.code === 'auth/account-exists-with-different-credential') {
		    //Save the would be credential and get email
		    var pendingCred = error.credential;
		    var email = error.email;
		    // Get sign-in methods for this email.
		    auth.fetchSignInMethodsForEmail(email).then(function(methods) {
		     	// If one of the methods is email and password sign in use that one.
					console.log(methods)
		      if (methods.includes('password')) {
		        // Basic prompt for password, may change later.
						// TODO: Add page for password prompt
		        var password = window.prompt("Enter password for original account","");
						// Sign in using the email and password provided
		        auth.signInWithEmailAndPassword(email, password).then(function(user) {
							// If login was successful get user id and link it with the pending credential
							firebase.auth().onAuthStateChanged(function(user) {
								return user.linkWithCredential(pendingCred);
							})
		        }).then(function() {
		          // Facebook account successfully linked to the existing Firebase user.
							var checkRegistrationStatus = firebase.functions().httpsCallable('checkRegistrationStatus');
							checkRegistrationStatus({uid: auth.currentUser.uid}).then(function(result) {
								if(result.data) {
									// they have completed the registration process (account setup)
									window.location.href = "dashboard.html";
								} else {
									// they have not completed setup
									window.location.href = "accountsetup.html";
								}
							})
		        });
		        return;
		      } else {
						// If they are only signed up using google
						if (methods.includes('google.com')) {
			        // Validate user login
			        var provider = new firebase.auth.GoogleAuthProvider();
							auth.signInWithPopup(provider).then(function(result) {
								// Use pending cred to link to existing account.
								result.user.linkWithCredential(pendingCred).then(function(usrcred) {
			          	// Facebook account successfully linked to the existing Firebase user.
									var checkRegistrationStatus = firebase.functions().httpsCallable('checkRegistrationStatus');
									checkRegistrationStatus({uid: auth.currentUser.uid}).then(function(result) {
										if(result.data) {
											// they have completed the registration process (account setup)
											window.location.href = "dashboard.html";
										} else {
											// they have not completed setup
											window.location.href = "accountsetup.html";
										}
									})
			        }).catch(function(error) {
								$('#fullBackgroundContainer *').attr("hidden", false).on('click');
								document.getElementById('loadingAnimation').hidden = true;
							});
			        return;
			      });
					}
				}
			});
		}
	});
})
	</script>
</body>
</html>
