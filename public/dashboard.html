<!DOCTYPE html>
<html>
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="/__/firebase/7.12.0/firebase-app.js"></script>
  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="/__/firebase/7.12.0/firebase-analytics.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

  <!-- Initialize Firebase -->
  <script src="/__/firebase/init.js"></script>
  <script src="/__/firebase/7.12.0/firebase-auth.js"></script>
  <script src="/__/firebase/7.12.0/firebase-database.js"></script>
  <script src="/__/firebase/7.12.0/firebase-functions.js"></script>
  <script type="text/javascript">
    var functions = firebase.functions();
    var auth = firebase.auth();
    var signingOut = false;
    auth.onAuthStateChanged(function(user) {
      
        if (!user) {
          if(signingOut) {
            window.location.href = "homepage.html";
          } else {
            alert("No User is logged in!");
            window.location.href = "/";
          }
        } else {
          // there is a logged in user, check if they have completed the registration process
          var checkRegistrationStatus = firebase.functions().httpsCallable('checkRegistrationStatus');
          checkRegistrationStatus({uid: auth.currentUser.uid}).then(function(result) {
            if(result.data) {
              // they have completed the registration process (account setup)
              removeLoading();
            } else {
              window.location.href = "accountsetup.html";
            }
          })

        }
    });
  </script>

  <style>
    body {
      margin: 0;
      font-family: "Lato", sans-serif;
    }

    a {
      cursor: pointer;
    }

    .sidebaropen {
      margin: 0;
      padding: 0;
      width: 250px;
      background-color: #25262D;
      position: fixed;
      height: 100%;
      overflow: auto;
      z-index: 1;
      top: 0;
      left: 0;
      overflow-x: hidden;
      padding-top: 60px;
      transition: 0.5s;
    }

    .sidebaropen a {
      display: block;
      color: white;
      padding: 18px;
      text-decoration: none;
      border-top: 0.5px solid #606060;
      border-bottom: 0.5px solid #606060;
      /*border-bottom: 0.5px solid #606060;
      border-left: 0.5px solid #606060;*/
    }
     
    .sidebaropen a.active {
      background-color: #419385;
      color: white;
      text-decoration-style: bold;
    }

    .sidebaropen a:hover:not(.active) {
      background-color: #89CAD4;
      color: white;
    }

    .sidebaropen .closebtn {
      position: absolute;
      top: 0;
      right: 0px;
      margin-left: 50px;
      border-width: 0px; 
      font-size: 26px;
    }

    .sidebaropen a.closebtn:hover {
      color: #f1f1f1;
      background-color: #25262D;
    }

    #home {
      margin-top: 10px;
    }

    div.content {
      margin-left: 250px;
      padding: 1px 16px;
      height: 1000px;
      transition: 0.5s;
    }

    svg{
      width: 100px;
      height: 100px;
      left: 50%;
      display:inline-block;
    }
    svg circle {
      stroke: #419385;
    }
    svg rect {
      fill: #89CAD4;
    }
    #loadingAnimation {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }

    .notif {
      background-color: #419385;
      border-radius: 20px;
      padding: 10px;
      width: 70%;
      margin: 0 auto;
      margin-bottom: 3%;
      position: relative;
      overflow: hidden;
      transition: background-color 0.25s;
      -webkit-transition: background-color 0.25s;
    }
    .notif:hover {
      background-color: #89CAD4;
    }
    .notif p {
      color: white;
    }
    .notif #title {
      font-size: 25px;
    }
    #nonotifs {
      color: grey;
      font-style: italic;
      margin-top: 20%;
    }

    @media screen and (max-width: 700px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .sidebar a {float: left;}
      div.content {margin-left: 0;}
    }

    @media screen and (max-width: 400px) {
      .sidebar a {
        text-align: center;
        float: none;
      }
    }

    @media screen and (max-height: 450px) {
      .sidebar {padding-top: 15px;}
      .sidebar a {font-size: 18px;}
    }
  </style>
  </head>
  <body onload="displayLoading();">

    <div id="fullBackgroundContainer">
      <div id="loadingAnimation" class="center" hidden=true>
    <svg version="1.1" id="L1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
    <circle fill="none" stroke-width="6" stroke-miterlimit="15" stroke-dasharray="14.2472,14.2472" cx="50" cy="50" r="47" >
      <animateTransform 
         attributeName="transform" 
         attributeType="XML" 
         type="rotate"  
         dur="5s" 
         from="0 50 50"
         to="360 50 50" 
         repeatCount="indefinite" />
  </circle>
  <circle fill="none" stroke="#fff" stroke-width="1" stroke-miterlimit="10" stroke-dasharray="10,10" cx="50" cy="50" r="39">
      <animateTransform 
         attributeName="transform" 
         attributeType="XML" 
         type="rotate"
         dur="5s" 
         from="0 50 50"
         to="-360 50 50" 
         repeatCount="indefinite" />
  </circle>
  <g fill="#fff">
  <rect x="30" y="35" width="5" height="30">
    <animateTransform 
       attributeName="transform" 
       dur="1s" 
       type="translate" 
       values="0 5 ; 0 -5; 0 5" 
       repeatCount="indefinite" 
       begin="0.1"/>
  </rect>
  <rect x="40" y="35" width="5" height="30" >
    <animateTransform 
       attributeName="transform" 
       dur="1s" 
       type="translate" 
       values="0 5 ; 0 -5; 0 5" 
       repeatCount="indefinite" 
       begin="0.2"/>
  </rect>
  <rect x="50" y="35" width="5" height="30" >
    <animateTransform 
       attributeName="transform" 
       dur="1s" 
       type="translate" 
       values="0 5 ; 0 -5; 0 5" 
       repeatCount="indefinite" 
       begin="0.3"/>
  </rect>
  <rect x="60" y="35" width="5" height="30" >
    <animateTransform 
       attributeName="transform" 
       dur="1s" 
       type="translate" 
       values="0 5 ; 0 -5; 0 5"  
       repeatCount="indefinite" 
       begin="0.4"/>
  </rect>
  <rect x="70" y="35" width="5" height="30" >
    <animateTransform 
       attributeName="transform" 
       dur="1s" 
       type="translate" 
       values="0 5 ; 0 -5; 0 5" 
       repeatCount="indefinite" 
       begin="0.5"/>
  </rect>
  </g>
</svg>
  </div>


      <div id="mySidebar" class="sidebaropen">
        <a class="closebtn" id="closebtn" onclick="navOperator()" data-open=true>&times;</a>
        <a id="home" onclick="homeClicked();">Home</a>
        <a id="notifications" onclick="notificationsClicked()">Notifications</a>
        <a id="reservations" onclick="reservationsClicked();">Reservations</a>
        <a id="requests" onclick="requestsClicked();">Requests</a>
        <a id="news" onclick="newsClicked();">Covid-19 Awareness</a>
        <a id="settings" onclick="settingsClicked();">Settings</a>
        <a id="logout" onclick="logout();">Logout</a>

      </div>

      <!--<div id="main">
        <button class="openbtn" onclick="openNav()">&#9776; Open Sidebar</button>
      </div>-->

      <div class="content" id="contentDiv">
        <div id="homeDiv">
          <h1>Home</h1>
        </div>

        <div id="notificationsDiv"></div>

        <div id="reservationsDiv">
          <h1>Reservations</h1>
        </div>

        <div id="requestsDiv">
          <h1>Requests</h1>
        </div>

        <div id="newsDiv">
          <h1>Covid-19 Awarness</h1>
        </div>

        <div id="settingsDiv" class="container">
          <div id="header" class="page-header">
            <h1>Settings</h1>
          </div>
          <div id="form" class="jumbotron">
            <form action="#" id="changes" method="post">
              <div id="selMed" class="form-group">
                <label for="medSelect">Medical Condition<b data-toggle="tooltip" title="Any conditions that poses you at a higher risk, e.g., asthma, chronic lung disease, heart conditions, immunocompromised, etc.">?</b></label>
                <select class="form-control" id="medSelect">
                  <option id="selNo">No</option>
                  <option id="selYes">Yes</option>
                </select>
              </div>
              <div id="selHelper" class="form-group">
                <label for="helperSelect">Helper<b data-toggle="tooltip" title="Person who volunteers to help people in need. This option can be changed in account settings later.">?</b></label>
                <select class="form-control" id="helperSelect">
                  <option id="selNo">No</option>
                  <option id="selYes">Yes</option>
                </select>
              </div>
              <div id="selRad" class="form-group">
                <label for="radiusSelect">Preferred radius (miles)</label>
                <select class="form-control" id="radiusSelect">
                  <option>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </div>
              <div id="changePw" class="form-group">
                <label for="pwChange">Change Password</label>
                <input class="form-control" id="pwChange">
              </div>
            </form>
            <div id="confirmButton">
              <input id="confirm" type="button" class="btn" value="Save Changes">
            </div>
          </div>
        </div>
      </div>
    </div>


    <script type="text/javascript">
      function makeActive(id) {
        let activeList = document.getElementsByClassName("active")
        if (activeList.length == 1) {
          activeList[0].classList.remove("active");
        }
        document.getElementById(id).classList.add("active");
        //let contentDiv = document.getElementById("contentDiv");
        let childNodes = $("#contentDiv").children();
        let div = document.getElementById(id+"Div");
        for(var i=0;i<childNodes.length;i++) {
          if(childNodes[i].id == div.id) {
            $("#"+id+"Div").show();
            continue;
          } else {
            $("#"+childNodes[i].id).hide();
          }
        }
      }

      function displayLoading() {
        $('#fullBackgroundContainer *').attr("disabled", "disabled").off('click');
        document.getElementById('loadingAnimation').hidden = false;
      }

      function removeLoading() {
        $('#fullBackgroundContainer *').attr("disabled", false).on('click');
        document.getElementById('loadingAnimation').hidden = true;
      }

      function navOperator() {
        // opens or closes the tag depending on current state
        if(document.getElementById('closebtn').dataset.open == "true") {
          document.getElementById('closebtn').dataset.open = "false";
          document.getElementById("mySidebar").style.width = "50px";
          document.getElementById("contentDiv").style.marginLeft = "50px"
          document.getElementById("closebtn").innerHTML = "&#9776";
          document.getElementById("home").innerHTML = "<i class='glyphicon glyphicon-home'></i>";
          document.getElementById("notifications").innerHTML = "<i class='glyphicon glyphicon-bell'></i>";
          document.getElementById("reservations").innerHTML = "<i class='glyphicon glyphicon-book'></i>";
          document.getElementById("requests").innerHTML = "<i class='glyphicon glyphicon-shopping-cart'></i>";
          document.getElementById("news").innerHTML = "<i class='glyphicon glyphicon-bullhorn'></i>";
          document.getElementById("settings").innerHTML = "<i class='glyphicon glyphicon-cog'></i>";
          document.getElementById("logout").innerHTML = "<i class='glyphicon glyphicon-log-out'></i>";
        } else {
          document.getElementById('closebtn').dataset.open = "true";
          document.getElementById("mySidebar").style.width = "250px";
          document.getElementById("contentDiv").style.marginLeft = "250px"
          document.getElementById("closebtn").innerHTML = "&times";
          document.getElementById("home").innerHTML = "Home";
          document.getElementById("notifications").innerHTML = "Notifications";
          document.getElementById("reservations").innerHTML = "Reservations";
          document.getElementById("requests").innerHTML = "Requests";
          document.getElementById("news").innerHTML = "Covid-19 Awareness";
          document.getElementById("settings").innerHTML = "Settings";
          document.getElementById("logout").innerHTML = "Logout";
        }
      }

      function homeClicked() {
        makeActive("home");
      }

      function notificationsClicked() {
        makeActive("notifications");
        displayLoading();
        let notificationsDiv = document.getElementById("notificationsDiv");
        // clearing the div to get rid of previous notifications
        notificationsDiv.innerHTML = "";
        var title = document.createElement("h1");
        title.id = "notifsTitle";
        title.innerHTML = "Notifications";
        notificationsDiv.appendChild(title);
        var notifGet = firebase.functions().httpsCallable('getNotificationsForUser');
        notifGet({uid: auth.currentUser.uid}).then(function(result) {
          var data = result.data;
          console.log(Object.keys(result.data))
          if(Object.keys(result.data).length > 0) {

            Object.keys(result.data).forEach(function(key) {
              var notifDiv = document.createElement("div");
              notifDiv.classList.add("notif");
              var title = document.createElement("p");
              title.id = "title";
              title.innerHTML = result.data[key].title;
              var text = document.createElement("p");
              text.id = "text";
              text.innerHTML = result.data[key].text;
              var date = document.createElement("p");
              date.id = "date";
              date.innerHTML = result.data[key].date;
              notifDiv.appendChild(title);
              notifDiv.appendChild(text);
              notifDiv.appendChild(date);
              notificationsDiv.appendChild(notifDiv);
            });
          } else {
            // no notifications to show to the user
            var nope = document.createElement("p");
            nope.id = "nonotifs";
            nope.align = "center";
            nope.innerHTML = "No notifications to display.";
            notificationsDiv.appendChild(nope);
          }
        })
        removeLoading();

      }

      function reservationsClicked() {
        makeActive("reservations");
      }

      function newsClicked() {
        makeActive("news");
      }

      function settingsClicked() {
        makeActive("settings");
      }

      function requestsClicked() {
        makeActive("requests");
      }

      function logout() {
        signingOut = true;
        auth.signOut();
      }

      makeActive("home");

    </script>

</body>
</html>
